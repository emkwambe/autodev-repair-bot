"""
PR Body Generator for AutoDev.

Creates informative, trust-building PR descriptions.
"""

from autodev.state import AutoDevState
from autodev.policy.diff_guard import extract_patch_stats


def build_pr_body(state: AutoDevState) -> str:
    """
    Build a comprehensive PR description with evidence.
    
    Args:
        state: Final agent state
        
    Returns:
        Markdown-formatted PR body
    """
    # Extract patch statistics
    patch_stats = {}
    if state.proposed_patch:
        patch_stats = extract_patch_stats(state.proposed_patch)
    
    # Truncate logs for readability
    failure_summary = state.failure_logs or "No failure logs available"
    if len(failure_summary) > 1000:
        failure_summary = failure_summary[:1000] + "\n... (truncated)"
    
    # Build the body
    body = f"""## ü§ñ AutoDev Verified Fix

This pull request was automatically generated by AutoDev after verifying the fix passes all tests in a sandboxed environment.

### Failure Summary

```
{failure_summary}
```

### Root Cause Analysis

{state.root_cause_analysis or state.fix_strategy or "Analysis not available"}

### Verification Evidence

| Check | Status |
|-------|--------|
| Sandbox Execution | ‚úÖ PASS |
| Test Suite | ‚úÖ PASS |
| Policy Compliance | ‚úÖ PASS |

### Change Statistics

- **Files Changed:** {patch_stats.get('files_changed', 'N/A')}
- **Lines Added:** {patch_stats.get('additions', 'N/A')}
- **Lines Removed:** {patch_stats.get('deletions', 'N/A')}
- **Attempts Used:** {state.attempt + 1}/{state.max_attempts}

### Safety Guarantees

- ‚úÖ No test files modified
- ‚úÖ No CI configuration changed
- ‚úÖ Minimal diff policy enforced
- ‚úÖ All changes verified in Docker sandbox

### Rollback

If this fix introduces issues, revert with:

```bash
git revert <commit-sha>
```

---
*Generated by [AutoDev Repair Bot](https://github.com/yourusername/autodev-repair-bot)*
"""
    
    return body


def build_diagnostic_report(state: AutoDevState) -> str:
    """
    Build a diagnostic report when repair fails.
    
    Args:
        state: Final agent state
        
    Returns:
        Markdown-formatted diagnostic report
    """
    # Truncate logs
    failure_summary = state.failure_logs or "No logs available"
    if len(failure_summary) > 800:
        failure_summary = failure_summary[:800] + "\n... (truncated)"
    
    # Format policy violations
    violations_text = "None"
    if state.policy_violations:
        violations_text = "\n".join(f"- {v}" for v in state.policy_violations)
    
    # Flaky test info
    flaky_info = "Not detected"
    if state.flaky_detected:
        results = ["PASS" if r else "FAIL" for r in state.flaky_runs]
        flaky_info = f"‚ö†Ô∏è Flaky test detected. Run results: {', '.join(results)}"
    
    report = f"""## ü§ñ AutoDev Diagnostic Report

AutoDev attempted to repair this failure but could not produce a verified fix.

### Status
**Repair Aborted** - {state.stop_reason or "Unknown reason"}

### Failure Summary

```
{failure_summary}
```

### Attempts Made
{state.attempt + 1} of {state.max_attempts} maximum attempts

### Policy Violations
{violations_text}

### Flaky Test Detection
{flaky_info}

### Recommended Actions

1. **If flaky test:** Investigate test isolation and timing dependencies
2. **If policy violation:** The required fix may be too large or touch protected files
3. **If infrastructure issue:** Check environment, dependencies, or CI configuration

### What AutoDev Tried

{state.root_cause_analysis or "Analysis not available"}

---
*This is an automated diagnostic report. Manual intervention required.*
"""
    
    return report
