"""
AutoDev State Model

Single source of truth for the repair agent state machine.
All data persisted between LangGraph nodes lives here.
"""

from typing import Optional
from pydantic import BaseModel, Field


class AutoDevState(BaseModel):
    """
    Immutable state passed through the LangGraph repair loop.
    
    This state accumulates information as the agent progresses:
    - Failure context
    - Proposed fixes
    - Validation results
    - Policy violations
    - Final outcomes
    """
    
    # Repository configuration
    repo_path: str = Field(description="Path to the repository being repaired")
    test_command: str = Field(default="pytest -q", description="Command to run tests")
    
    # Attempt tracking
    attempt: int = Field(default=0, description="Current attempt number (0-indexed)")
    max_attempts: int = Field(default=2, description="Maximum repair attempts allowed")
    
    # Failure context
    failure_logs: Optional[str] = Field(default=None, description="Raw test failure output")
    context_files: dict[str, str] = Field(
        default_factory=dict, 
        description="Relevant source files extracted from stack traces"
    )
    
    # LLM reasoning
    root_cause_analysis: Optional[str] = Field(
        default=None, 
        description="LLM explanation of the failure root cause"
    )
    fix_strategy: Optional[str] = Field(
        default=None, 
        description="LLM proposed fix strategy"
    )
    proposed_patch: Optional[str] = Field(
        default=None, 
        description="Unified diff generated by LLM"
    )
    
    # Validation results
    policy_violations: list[str] = Field(
        default_factory=list, 
        description="List of policy rules violated by proposed patch"
    )
    patch_applied: bool = Field(default=False, description="Whether patch was successfully applied")
    sandbox_passed: bool = Field(default=False, description="Whether sandbox tests passed")
    
    # Flaky detection (Sprint 3)
    flaky_detected: bool = Field(default=False, description="Whether test was detected as flaky")
    flaky_runs: list[bool] = Field(
        default_factory=list, 
        description="Results of flakiness detection runs"
    )
    
    # Dependency handling
    is_dependency_issue: bool = Field(
        default=False, 
        description="Whether failure is a dependency/import issue"
    )
    allow_deps: bool = Field(
        default=False, 
        description="Whether dependency changes are permitted"
    )
    
    # Final outcome
    stop_reason: Optional[str] = Field(
        default=None, 
        description="Reason the agent stopped (if not successful)"
    )
    pr_url: Optional[str] = Field(
        default=None, 
        description="URL of the created pull request (if successful)"
    )
    
    class Config:
        """Pydantic configuration."""
        frozen = False  # Allow mutation during graph traversal
        validate_assignment = True
